#!/bin/bash

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞
display_logo() {
  echo -e '\e[40m\e[32m'
  echo -e '‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó '
  echo -e '‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó'
  echo -e '‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù'
  echo -e '‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó'
  echo -e '‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë'
  echo -e '‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù'
  echo -e '\e[0m'
  echo -e "\n–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª may.crypto{ü¶Ö} —á—Ç–æ–±—ã –±—ã—Ç—å –≤ –∫—É—Ä—Å–µ —Å–∞–º—ã—Ö –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–¥ - https://t.me/maycrypto\n"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é
display_menu() {
  echo "–ú–µ–Ω—é:"
  echo "1. –°–æ–∑–¥–∞—Ç—å –ø–∞—Ä–æ–ª—å"
  echo "2. –í–≤–µ—Å—Ç–∏ Run command"
  echo "3. –í–≤–µ—Å—Ç–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –æ—Ç –∫–æ—à–µ–ª—å–∫–∞"
  echo "4. –í–≤–µ—Å—Ç–∏ –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –≤ —Å–µ—Ç–∏ Ethereum"
  echo "5. –ó–∞–ø—É—Å—Ç–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É Puffer (Holesky Testnet)"
  echo "6. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É Active"
  echo "7. –í—ã–π—Ç–∏ –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞"
  read -p "–í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –º–µ–Ω—é: " choice
  case $choice in
    1) create_password ;;
    2) input_run_command ;;
    3) input_private_key ;;
    4) input_wallet_address ;;
    5) install_puffer ;;
    6) fix_active_error ;;
    7) exit_script ;;
    *) echo "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞." ;;
  esac
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è
create_password() {
  read -sp "–°–æ–∑–¥–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –∑–∞—â–∏—Ç—ã Validator Keys: " password
  echo $password > password.txt
  echo -e "\n–ü–∞—Ä–æ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª password.txt"
  display_menu
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–≤–æ–¥–∞ Run command
input_run_command() {
  read -p "–í–≤–µ–¥–∏—Ç–µ –í–∞—à Run Command —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ª–∞—É–Ω—á–ø–∞–¥–∞ Puffer (https://launchpad.puffer.fi/Setup): " run_command
  run_command=${run_command//<PATH_TO_A_KEYSTORE_PASSWORD_FILE>/password.txt}
  run_command=${run_command//<PATH_TO_REGISTRATION_JSON>/registration.json}
  echo $run_command > run_command.txt
  echo "Run Command —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª run_command.txt"
  display_menu
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–≤–æ–¥–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
input_private_key() {
  read -sp "–í–≤–µ–¥–∏—Ç–µ –í–∞—à –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –æ—Ç –∫–æ—à–µ–ª—å–∫–∞. –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –º–æ–∂–Ω–æ –≤ Metamask: " private_key
  echo $private_key > jwtsecret
  echo -e "\n–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª jwtsecret"
  display_menu
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–∞ –∫–æ—à–µ–ª—å–∫–∞
input_wallet_address() {
  read -p "–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –í–∞—à–µ–≥–æ –∫–æ—à–µ–ª—å–∫–∞ –≤ —Å–µ—Ç–∏ Ethereum: " wallet_address
  echo $wallet_address > wallet_address.txt
  echo "–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª wallet_address.txt"
  display_menu
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Puffer (Holesky Testnet)
install_puffer() {
  sudo apt update && sudo apt upgrade -y
  sudo apt install build-essential curl screen -y
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  source $HOME/.cargo/env
  echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc
  source ~/.bashrc
  rustc --version
  sudo apt update
  sudo apt install libssl-dev pkg-config -y
  export OPENSSL_DIR=/usr/include/openssl
  echo 'export OPENSSL_DIR=/usr/include/openssl' >> ~/.bashrc
  source ~/.bashrc
  export OPENSSL_LIB_DIR=/usr/lib/x86_64-linux-gnu
  export OPENSSL_INCLUDE_DIR=/usr/include/openssl
  echo 'export OPENSSL_LIB_DIR=/usr/lib/x86_64-linux-gnu' >> ~/.bashrc
  echo 'export OPENSSL_INCLUDE_DIR=/usr/include/openssl' >> ~/.bashrc
  source ~/.bashrc
  pkg-config --version
  pkg-config --libs openssl
  mkdir -p ~/puffer/coral
  cd ~/puffer
  git clone https://github.com/PufferFinance/coral
  cd coral
  cargo build --release || (cargo clean && cargo build --release)
  cp ~/password.txt .
  bash ~/run_command.txt
  cd
  sudo apt-get install build-essential git-lfs cmake -y
  openssl rand -hex 32 | tr -d "\n" > "/tmp/jwtsecret"
  cp ~/jwtsecret /tmp/
  git clone https://github.com/status-im/nimbus-eth2
  cd nimbus-eth2
  make -j8 nimbus_beacon_node
  build/nimbus_beacon_node trustedNodeSync \
    --network:holesky \
    --data-dir=build/data/shared_holesky_0 \
    --trusted-node-url=https://holesky-checkpoint-sync.stakely.io/
  cp ~/puffer/coral/etc/keys/bls_keys/* ~/nimbus-eth2/build/data/shared_holesky_0/validators/
  mkdir -p ~/nimbus-eth2/validator_keys/
  cp ~/nimbus-eth2/build/data/shared_holesky_0/validators/* ~/nimbus-eth2/validator_keys/keystore.json
  screen -dmS consensus
  screen -S consensus -X stuff "cd ~/nimbus-eth2/\n"
  screen -S consensus -X stuff "build/nimbus_beacon_node deposits import --data-dir=~/nimbus-eth2/validator_keys/keystore.json\n"
  wallet_address=$(cat ~/wallet_address.txt)
  screen -S consensus -X stuff "./run-holesky-beacon-node.sh --web3-url=http://127.0.0.1:8551 --suggested-fee-recipient=$wallet_address --jwt-secret=/tmp/jwtsecret\n"
  wget https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
  sudo dpkg -i packages-microsoft-prod.deb
  sudo apt-get update
  sudo apt-get install dotnet-sdk-8.0 dotnet-runtime-8.0 -y
  dotnet --list-sdks
  dotnet --list-runtimes
  git clone https://github.com/NethermindEth/nethermind.git
  cd nethermind/src/Nethermind/
  dotnet build Nethermind.sln -c Release
  screen -dmS execution
  screen -S execution -X stuff "cd ~/nethermind/src/Nethermind/Nethermind.Runner\n"
  screen -S execution -X stuff "dotnet run -c Release -- --config=holesky --datadir='../../../../nethermind-datadir' --JsonRpc.Host=0.0.0.0 --JsonRpc.JwtSecretFile=/tmp/jwtsecret\n"
  echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª ~/puffer/coral/registration.json –Ω–∞ —Å–≤–æ–π –ü–ö –∏ –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ Puffer Dashboard."
  display_menu
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏ Active
fix_active_error() {
  screen -r consensus -X stuff "^C"
  screen -r execution -X stuff "^C"
  rm -r nethermind-datadir
  cd ~/nimbus-eth2
  build/nimbus_beacon_node deposits import --data-dir=build/data/shared_holesky_0
  read -sp "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –æ—Ç —Å–≤–æ–∏—Ö Validator Keys: " validator_password
  echo $validator_password | build/nimbus_beacon_node deposits import --data-dir=build/data/shared_holesky_0
  screen -dmS consensus
  wallet_address=$(cat ~/wallet_address.txt)
  screen -S consensus -X stuff "cd ~/nimbus-eth2/\n"
  screen -S consensus -X stuff "./run-holesky-beacon-node.sh --web3-url=http://127.0.0.1:8551 --suggested-fee-recipient=$wallet_address --jwt-secret=/tmp/jwtsecret\n"
  screen -dmS execution
  screen -S execution -X stuff "cd ~/nethermind/src/Nethermind/Nethermind.Runner\n"
  screen -S execution -X stuff "dotnet run -c Release -- --config=holesky --datadir='../../../../nethermind-datadir' --JsonRpc.Host=0.0.0.0 --JsonRpc.JwtSecretFile=/tmp/jwtsecret\n"
  echo "–í –±–ª–∏–∂–∞–π—à–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –í–∞—à —Å—Ç–∞—Ç—É—Å Active –¥–æ–ª–∂–µ–Ω —Å–º–µ–Ω–∏—Ç—å—Å—è –Ω–∞ –∑–µ–ª–µ–Ω—ã–π. –ï—Å–ª–∏ —ç—Ç–æ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ - –ø—Ä–æ–¥–µ–ª–∞–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –Ω–æ–¥—ã —Å –Ω—É–ª—è, –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏–≤ —Å–µ—Ä–≤–µ—Ä."
  display_menu
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞
exit_script() {
  echo "–í—ã—Ö–æ–¥ –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞..."
  exit 0
}

# –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ —Å–∫—Ä–∏–ø—Ç–∞
display_logo
display_menu
